{% extends 'default.html' %}

{% set active_page = "dashboard" %}

{% block title %}
  Alias Contact Manager
{% endblock %}

{% block default_content %}
  <div class="row">
    <div class="col">
      <h1 class="h3"
        title="ç»™ä½ è¿™ä¸ªåˆ«åé‚®ç®±å‘è¿‡é‚®ä»¶çš„ Email åœ°å€ä¼šè‡ªåŠ¨å‡ºç°åœ¨ä¸‹é¢çš„åˆ—è¡¨é‡Œï¼Œ
               æˆ–è€…ä½ å¯ä»¥è‡ªå·±æ‰‹åŠ¨åˆ›å»ºè”ç³»äººã€‚"
      > {{ alias.email }} çš„è”ç³»äºº<i class="fe fe-help-circle"></i>
        <a class="ml-3 text-info" style="font-size: 12px" data-toggle="collapse" href="#howtouse" role="button"
           aria-expanded="false" aria-controls="collapseExample">
          å¦‚ä½•ä½¿ç”¨ <i class="fe fe-chevrons-down"></i>
        </a>
      </h1>

      <div class="alert alert-primary collapse" id="howtouse" role="alert">
        <p>
          ä½ æƒ³è¦ä»ä½ çš„åˆ«åï¼Œç»™åˆ«äººå‘é€ç”µå­é‚®ä»¶ï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ª<em>åå‘åˆ«å</em>ï¼Œå³
          ä¸€ä¸ªç‰¹æ®Šçš„ç”µå­é‚®ä»¶åœ°å€ã€‚<br>
          å½“ä½ ç”¨è‡ªå·±çš„çœŸå®é‚®ç®±ï¼Œå‘åå‘åˆ«åå‘é€ç”µå­é‚®ä»¶æ—¶ï¼Œè¯¥ç”µå­é‚®ä»¶å°†<b>ä»ä½ çš„åˆ«å</b>å‘é€åˆ°è”ç³»äººã€‚
          <br>
        </p>
        <p>
          {% if alias.mailbox_id %}
            {% if alias.mailboxes | length == 1 %}
              ä¸€å®šè¦ä»é‚®ç®± <em>{{ alias.mailbox.email }}</em> å‘é€ç”µå­é‚®ä»¶ã€‚å¦åˆ™ä¼šè¢«æœ¬ç½‘ç«™æ‹’æ”¶ã€‚<br>
              <p style="color: red;">è¿™é‡Œä¸€å®šè¦æ³¨æ„ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé™åˆ¶ã€‚ä¸ç„¶åˆ«äººçŸ¥é“äº†ä½ çš„åå‘åˆ«åï¼Œè°éƒ½å¯ä»¥å†’å……ä½ äº†ã€‚<p>
            {% else %}
              ä¸€å®šè¦ä»ä»¥ä¸‹é‚®ç®±ä¹‹ä¸€å‘é€ç”µå­é‚®ä»¶ï¼š<br>
              {% for mailbox in alias.mailboxes %}
                - <b>{{ mailbox.email }}</b> <br>
              {% endfor %}
              <p style="color: red;">è¿™é‡Œä¸€å®šè¦æ³¨æ„ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé™åˆ¶ã€‚ä¸ç„¶åˆ«äººçŸ¥é“äº†ä½ çš„åå‘åˆ«åï¼Œè°éƒ½å¯ä»¥å†’å……ä½ äº†ã€‚<p>
            {% endif %}
          {% else %}
            ç¡®ä¿ä»ä¸ªäººç”µå­é‚®ä»¶åœ°å€å‘é€ç”µå­é‚®ä»¶ ({{ current_user.email }}).<br>
            <p style="color: red;">è¿™é‡Œä¸€å®šè¦æ³¨æ„ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé™åˆ¶ã€‚ä¸ç„¶åˆ«äººçŸ¥é“äº†ä½ çš„åå‘åˆ«åï¼Œè°éƒ½å¯ä»¥å†’å……ä½ äº†ã€‚<p>
          {% endif %}
        </p>
      </div>
    </div>

  </div>

  <form method="post">
    <input type="hidden" name="form-name" value="create">
    {{ new_contact_form.csrf_token }}

    <label class="form-label">ä½ æƒ³è¦å‘é‚®ä»¶ç»™è°ï¼Ÿ</label>

    {{ new_contact_form.email(class="form-control", placeholder="å å§“ <email@example.com> æˆ–è€… ç›´æ¥å¡«å†™é‚®ç®±åœ°å€ä¹Ÿå¯ä»¥", autofocus=True) }}
    {{ render_field_errors(new_contact_form.email) }}
    <button class="btn btn-primary mt-2">åˆ›å»ºåå‘åˆ«å</button>
  </form>

  <div class="row">
    {% for contact_info in contact_infos %}
      {% set contact = contact_info.contact %}
      <div class="col-md-6">
        <div class="my-2 p-2 card {% if contact.id == highlight_contact_id %} highlight-row {% endif %}">
          <div class="mb-2">
            <span class="font-weight-bold">{{ contact.website_email }}</span>
            {% if contact.pgp_finger_print %}
              <span class="cursor" data-toggle="tooltip" data-original-title="PGP Enabled">ğŸ—</span>
            {% endif %}
          </div>

          <div>
            <span>
              <a href="{{ 'mailto:' + contact.website_send_to() }}"
                 data-toggle="tooltip"
                 title="æ‚¨å¯ä»¥å•å‡»æ­¤å¤„æ‰“å¼€æ‚¨çš„ç”µå­é‚®ä»¶å®¢æˆ·ç«¯ã€‚æˆ–è€…ä½¿ç”¨å¤åˆ¶æŒ‰é’® ğŸ‘‰"
                 class="font-weight-bold">*************************</a>

              <span class="clipboard btn btn-sm btn-success copy-btn" data-toggle="tooltip"
                    title="å¤åˆ¶åå‘åˆ«ååœ°å€"
                    data-clipboard-text="{{ contact.website_send_to() }}">
                    å¤åˆ¶åå‘åˆ«ååœ°å€
              </span>
            </span>
          </div>


          <div class="mb-2 text-muted small-text">
            {% if contact_info.latest_email_log != None %}
              {% set email_log = contact_info.latest_email_log %}

              {% if email_log.is_reply %}
                <i class="fa fa-reply mr-2" data-toggle="tooltip" title="ä½¿ç”¨è¿™ä¸ªåˆ«åå›å¤/å‘é‚®ä»¶"></i>
                {{ email_log.created_at | dt }}
              {% elif email_log.bounced %}
                <span class="text-danger">
                  <i class="fa fa-warning mr-2" data-toggle="tooltip"
                     title="ç”µå­é‚®ä»¶è¢«é€€å›ï¼Œæ— æ³•è½¬å‘è‡³æ‚¨çš„é‚®ç®±"></i>
                  {{ email_log.created_at | dt }}
                </span>
              {% elif email_log.blocked %}
                <i class="fa fa-ban mr-2 text-danger" data-toggle="tooltip" title="é‚®ä»¶è¢«å±è”½"></i>
                {{ email_log.created_at | dt }}
              {% else %}
                <i class="fa fa-paper-plane  mr-2" data-toggle="tooltip" title="ç”µå­é‚®ä»¶å·²å‘é€è‡³åˆ«å"></i>
                {{ email_log.created_at | dt }}
              {% endif %}
              <br>
              åˆ›å»ºäº{{ contact.created_at | dt }} 
            {% else %}
              æ²¡æ´»åŠ¨. åˆ›å»ºäº{{ contact.created_at | dt }}
            {% endif %}

            <div>
              <span class="alias-activity">{{ contact_info.nb_forward }}</span> ä¸ªè½¬å‘,
              <span class="alias-activity">{{ contact_info.nb_reply }}</span> ä¸ªå›å¤
            </div>
          </div>

          <a href="{{ url_for('dashboard.contact_detail_route', contact_id=contact.id) }}">ç¼–è¾‘ â¡</a>

          <form method="post">
            <input type="hidden" name="form-name" value="delete">
            <input type="hidden" name="contact-id" value="{{ contact.id }}">
            <span class="card-link btn btn-link float-right delete-forward-email text-danger">
                  åˆ é™¤
                </span>
          </form>

        </div>
      </div>
    {% endfor %}
  </div>

  <div class="row mt-3">
    <div class="col">
      <nav aria-label="Contact navigation">
        <ul class="pagination">
          <li class="page-item">
            <a class="btn btn-outline-secondary {% if page == 0 %}disabled{% endif %}"
               href="{{ url_for('dashboard.alias_contact_manager', alias_id=alias.id, page=page-1) }}">
              ä¸Šä¸€é¡µ</a>
          </li>
          <li class="page-item">
            <a class="btn btn-outline-secondary {% if last_page %}disabled{% endif %}"
               href="{{ url_for('dashboard.alias_contact_manager', alias_id=alias.id, page=page+1) }}">
              ä¸‹ä¸€é¡µ</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>

{% endblock %}


{% block script %}
  <script>
    $(".delete-forward-email").on("click", function (e) {
      let that = $(this);

      bootbox.confirm({
        message: "ä¸æ­¤è”ç³»äººç›¸å…³çš„æ‰€æœ‰æ´»åŠ¨ä¹Ÿå°†è¢«åˆ é™¤ï¼Œè¯·ç¡®è®¤ã€‚",
        buttons: {
          confirm: {
            label: 'æ˜¯çš„ï¼Œåˆ é™¤å®ƒ',
            className: 'btn-danger'
          },
          cancel: {
            label: 'å–æ¶ˆ',
            className: 'btn-outline-primary'
          }
        },
        callback: function (result) {
          if (result) {
            that.closest("form").submit();
          }
        }
      })


    });
  </script>
{% endblock %}