{% extends 'default.html' %}

{% set active_page = "setting" %}

{% block title %}
  Settings
{% endblock %}

{% block head %}
  <style>
      .card-title {
          font-size: 22px;
          font-weight: 600;
          margin-bottom: 3px;
      }
  </style>
{% endblock %}

{% block default_content %}

  <div class="col pb-3">
    <!-- Current plan -->
    <div class="card">
      <div class="card-body">
        <div class="card-title mb-3">当前计划</div>

        {% if current_user.lifetime %}
          您可以终身使用高级会员计划。
          {% if not current_user.paid_lifetime %}
            <br>
            为了支持 原邮邮箱，您可以切换到付费计划。<br>
            <a href="{{ url_for('dashboard.pricing') }}" class="btn btn-sm btn-outline-primary">升级</a>
          {% endif %}
        {% elif current_user.get_subscription() %}
          您当前处于 {{ current_user.get_subscription().plan_name() }} 计划中。<br>
          <a href="{{ url_for('dashboard.billing') }}" class="btn btn-outline-primary">
            管理计划订阅
          </a>
          {% if current_user.lifetime %}
            不过，你现在可以终身使用高级会员计划，因此请务必取消之前的计划 :).
          {% endif %}
        {% elif manual_sub and manual_sub.is_active() %}
          您正在使用的 高级会员计划 计划即将到期 {{ manual_sub.end_at | dt }}
          ({{ manual_sub.end_at.format("YYYY-MM-DD") }}).
          {% if manual_sub.is_giveaway %}
            <br>
              要获得附加功能并支持 原邮邮箱，您可以升级到高级计划。 <br>
            <a href="{{ url_for('dashboard.pricing') }}" class="btn btn-sm btn-outline-primary">升级</a>
          {% endif %}

        {% elif apple_sub and apple_sub.is_valid() %}
          您正在使用的 高级会员计划 计划即将到期 {{ apple_sub.expires_date | dt }}
          ({{ apple_sub.expires_date.format("YYYY-MM-DD") }}).
        {% elif coinbase_sub and coinbase_sub.is_active() %}
          您正在使用的 高级会员计划 计划即将到期 {{ coinbase_sub.end_at | dt }}
          ({{ coinbase_sub.end_at.format("YYYY-MM-DD") }}).
          <br>
          <a href="{{ url_for('dashboard.coinbase_checkout_route') }}"
             class="btn btn-sm btn-outline-primary" target="_blank">
             延长订阅 <i class="fe fe-external-link"></i>
          </a>

        {% elif current_user.in_trial() %}
          您的 高级会员计划 试用已到期 {{ current_user.trial_end | dt }}.
        {% else %}
          您采用的是免费计划。
        {% endif %}
      </div>
    </div>
    <!-- END Current plan -->

    <!-- TOTP -->
    <div class="card" id="totp">
      <div class="card-body">
        <div class="card-title">双因素认证</div>
        <div class="mb-3">
          使用 2FA 保护您的帐户，登录时系统会要求您输入通过应用程序生成的代码。 <br>
        </div>
        {% if not current_user.enable_otp %}
          <a href="{{ url_for('dashboard.mfa_setup') }}" class="btn btn-outline-primary">设置 TOTP</a>
        {% else %}
          <a href="{{ url_for('dashboard.mfa_cancel') }}" class="btn btn-outline-danger">禁用 TOTP</a>
          <a href="{{ url_for('dashboard.recovery_code_route') }}" class="btn btn-outline-secondary">恢复代码</a>
        {% endif %}
      </div>
    </div>
    <!-- END TOTP -->

    <!-- WebAuthn -->
    <div class="card">
      <div class="card-body">
        <div class="card-title">安全密钥 (WebAuthn)</div>
        <div class="mb-3">
          您可以通过将 FIDO 支持的物理密钥（例如 Yubikey、Google Titan 或具有适当硬件的设备）链接到您的帐户来保护您的帐户。
        </div>
        {% if current_user.fido_uuid is none %}
          <a href="{{ url_for('dashboard.fido_setup') }}" class="btn btn-outline-primary">设置 WebAuthn</a>
        {% else %}
          <a href="{{ url_for('dashboard.fido_manage') }}" class="btn btn-outline-info">管理 WebAuthn</a>
          <a href="{{ url_for('dashboard.recovery_code_route') }}" class="btn btn-outline-secondary">恢复代码</a>
        {% endif %}
      </div>
    </div>
    <!-- END WebAuthn -->


    <!-- Newsletter -->
    <div class="card" id="notification">
      <div class="card-body">
        <div class="card-title">时事通讯</div>
        <div class="mb-3">
          我们会偶尔向您发送包含新功能公告的电子邮件。
        </div>
        <form method="post">
          <input type="hidden" name="form-name" value="notification-preference">
          <div class="form-check">
            <input type="checkbox" id="notification" name="notification" {% if current_user.notification %}
                   checked {% endif %} class="form-check-input">
            <label for="notification">我希望在新功能发布时收到电子邮件通知。</label>
          </div>
          <button type="submit" class="btn btn-outline-primary">保存</button>
        </form>
      </div>
    </div>
    <!-- END Newsletter -->

    <!-- Change name & profile picture -->
    <div class="card">
      <form method="post" enctype="multipart/form-data">
        {{ form.csrf_token }}
        <input type="hidden" name="form-name" value="update-profile">

        <div class="card-body">
          <div class="card-title">
            个人资料
          </div>
          <div>
            当您使用使用 <em>原邮邮箱</em> 按钮登录时，此信息将自动填写。
          </div>
          <div class="form-group mt-3">
            <label class="form-label">姓名</label>
            {{ form.name(class="form-control", value=current_user.name) }}
            {{ render_field_errors(form.name) }}
          </div>

          <div class="form-group my-4">
            <div class="form-label">个人资料图片</div>
            {{ form.profile_picture(class="form-control-file") }}
            {{ render_field_errors(form.profile_picture) }}
            {% if current_user.profile_picture_id %}
              <img src="{{ current_user.profile_picture_url() }}" class="profile-picture">
            {% endif %}
          </div>
          <button class="btn btn-outline-primary">更新</button>
        </div>
      </form>
    </div>
    <!-- END change name & profile picture -->

    <!-- Change email -->
    <div class="card">
      <form method="post" enctype="multipart/form-data">
        <input type="hidden" name="form-name" value="update-email">
        {{ change_email_form.csrf_token }}

        <div class="card-body">
          <div class="card-title">
            登陆邮箱
          </div>
          <div class="mb-3">
            此电子邮件地址用于登录 原邮邮箱<br>
            如果您想更改电子邮件转发到的邮箱，请访问
            <a href="{{ url_for('dashboard.mailbox_route') }}">
              <i class="fe fe-inbox"></i> 收件箱
            </a> 修改.
          </div>
          <div class="form-group mt-2">
            <!-- Not allow user to change email if there's a pending change -->
            {{ change_email_form.email(class="form-control", value=current_user.email, readonly=pending_email != None) }}
            {{ render_field_errors(change_email_form.email) }}

            {% if pending_email %}
              <div class="mt-2">
                <span class="text-danger">待处理的电子邮件更改： {{ pending_email }}</span>
                <a href="{{ url_for('dashboard.resend_email_change') }}" class="btn btn-secondary btn-sm">重新发送验证电子邮件</a>
                <a href="{{ url_for('dashboard.cancel_email_change') }}" class="btn btn-secondary btn-sm">取消修改</a>
              </div>
            {% endif %}
          </div>
          <button class="btn btn-outline-primary">修改登陆邮箱</button>
        </div>
      </form>
    </div>
    <!-- END Change email -->

    <!-- Change password -->
    <div class="card">
      <div class="card-body">
        <div class="card-title">
          密码
        </div>
        <div class="mb-3">
          您将收到一封电子邮件，其中包含有关如何更改密码的说明。
        </div>
        <form method="post">
          <input type="hidden" name="form-name" value="change-password">
          <button class="btn btn-outline-primary">修改密码</button>
        </form>
      </div>
    </div>
    <!-- END Change password -->

    <!-- Random alias -->
    <div id="random-alias" class="card">
      <div class="card-body">
        <div class="card-title">别名</div>

        <div class="mt-3 mb-1">更改随机别名默认生成的方式</div>
        <form method="post" action="#random-alias" class="form-inline">
          <input type="hidden" name="form-name" value="change-alias-generator">
          <select class="form-control mr-sm-2" name="alias-generator-scheme">
            <option value="{{ AliasGeneratorEnum.word.value }}"
                {% if current_user.alias_generator == AliasGeneratorEnum.word.value %} selected {% endif %} > 基于随机单词 {{ AliasGeneratorEnum.word.name.capitalize() }}</option>
            <option value="{{ AliasGeneratorEnum.uuid.value }}"
                {% if current_user.alias_generator == AliasGeneratorEnum.uuid.value %} selected {% endif %} > 基于 {{ AliasGeneratorEnum.uuid.name.upper() }}</option>
          </select>
          <button class="btn btn-outline-primary">保存</button>
        </form>

        <div class="mt-3 mb-1">选择别名的默认后缀</div>
        <form method="post" action="#random-alias" class="form-inline">
          <input type="hidden" name="form-name" value="change-random-alias-default-domain">
          <select class="form-control mr-sm-2" name="random-alias-default-domain">
            {% for is_public, domain in current_user.available_domains_for_random_alias() %}
              <option value="{{ domain }}"
                  {% if current_user.default_random_alias_domain() == domain %} selected {% endif %} >
                {{ domain }} ({% if is_public %} 原邮官方后缀 {% else %} 你的域名 {% endif %})
              </option>
            {% endfor %}
          </select>
          <button class="btn btn-outline-primary">保存</button>
        </form>
      </div>
    </div>
    <!-- END Random alias -->

    <!-- Sender Format -->
    <div class="card" id="sender-format">
      <div class="card-body">
        <div class="card-title">发件人地址格式</div>
        <div class="mt-1 mb-3">
          当您的别名收到一封电子邮件时，例如发件人：<b>John Wick &lt;john@wick.com&gt;</b>，
          原邮邮箱 会将其转发到您的邮箱。<br>
          由于某些电子邮件限制，原邮邮箱 无法保留发件人电子邮件地址的原始格式，需要将其<b>转换</b>为以下格式之一。
        </div>

        <form method="post" action="#sender-format">
          <input type="hidden" name="form-name" value="change-sender-format">

          <select class="form-control mr-sm-2" name="sender-format">
            {# Only show this for compatibility reason #}
            {% if current_user.sender_format == SenderFormatEnum.VIA.value %}
              <option value="{{ SenderFormatEnum.VIA.value }}"
                  {% if current_user.sender_format == SenderFormatEnum.VIA.value %} selected {% endif %}>
                john@wick.com via 原邮邮箱 (Not recommended)
              </option>
            {% endif %}

            <option value="{{ SenderFormatEnum.AT.value }}"
                {% if current_user.sender_format == SenderFormatEnum.AT.value %} selected {% endif %}>
              John Wick - john at wick.com
            </option>

            <option value="{{ SenderFormatEnum.A.value }}"
                {% if current_user.sender_format == SenderFormatEnum.A.value %} selected {% endif %}>
              John Wick - john(a)wick.com
            </option>

            {# Only show this for compatibility reason #}
            {% if current_user.sender_format == SenderFormatEnum.FULL.value %}
              <option value="{{ SenderFormatEnum.FULL.value }}"
                  {% if current_user.sender_format == SenderFormatEnum.FULL.value %} selected {% endif %}>
                John Wick - john@wick.com (不推荐)
              </option>
            {% endif %}
          </select>

          <button class="btn btn-outline-primary mt-3">保存</button>
        </form>
      </div>
    </div>
    <!-- END Sender Format -->

    <!-- Reverse-alias -->
    {% if current_user.replace_reverse_alias %}
      <div class="card">
        <div class="card-body">
          <div class="card-title">反向别名替换</div>
          <div class="mb-3">
            回复转发的电子邮件时，您的电子邮件客户端会自动将<b>反向别名</b>包含在
            附加消息中。<br>
            启用此选项将用您的联系人电子邮件<b>替换</b>反向别名。<br>
            请注意，此选项与 Gmail UI 不兼容
            因为 Gmail 会自动丰富消息，从而破坏反向别名格式。
          </div>
          <form method="post">
            <input type="hidden" name="form-name" value="replace-ra">
            <div class="form-check">
              <input type="checkbox" id="replace-ra" name="replace-ra"
                  {% if current_user.replace_reverse_alias %} checked {% endif %} class="form-check-input">
              <label for="replace-ra">启用反向别名替换</label>
            </div>
            <button type="submit" class="btn btn-outline-primary">保存</button>
          </form>
        </div>
      </div>
    {% endif %}
    <!-- END Reverse-alias -->

    <!-- Sender included in reverse-alias -->
    <div class="card" id="sender-in-ra">
      <div class="card-body">
        <div class="card-title">在反向别名中包含发件人地址</div>
        <div class="mb-3">
          默认情况下，反向别名是随机生成的，不包含有关发件人的任何信息。<br>
          但是，您可以启用此选项以将发件人地址包含在反向别名中。<br>
          这在设置电子邮件过滤器时很有用，并使反向别名更具可读性。
        </div>
        <form method="post" action="#sender-in-ra">
          <input type="hidden" name="form-name" value="sender-in-ra">
          <div class="form-check">
            <input type="checkbox" id="include-sender-ra" name="enable"
                {# todo: remove current_user.include_sender_in_reverse_alias is none condition #}
                {% if current_user.include_sender_in_reverse_alias is none or current_user.include_sender_in_reverse_alias %} checked {% endif %} class="form-check-input">
            <label for="include-sender-ra">在反向别名中包含发件人地址</label>
          </div>
          <button type="submit" class="btn btn-outline-primary">保存</button>
        </form>
      </div>
    </div>
    <!-- END Reverse-alias -->

    <div class="card">
      <div class="card-body">
        <div class="card-title">隔离箱</div>
        <div class="mb-3">
          当发送到您的别名的电子邮件被归类为垃圾邮件或被您的电子邮件提供商拒绝时，
          这通常意味着您的别名已泄露给垃圾邮件发送者。<br>
          在这种情况下，原邮邮箱 将<b>保留</b>此电子邮件的副本（因此不会丢失）
          并通知您，以便您查看其内容并采取适当的措施。<br>
          这些电子邮件将在 7 天内删除。
          这是 原邮邮箱 存储电子邮件的例外情况。
        </div>
        <a href="{{ url_for('dashboard.refused_email_route') }}" class="btn btn-outline-primary">
          查看被拒绝的邮件
        </a>
      </div>
    </div>

    <!-- <div class="card">
      <div class="card-body">
        <div class="card-title">Alias Import</div>
        <div class="mb-3">
          You can import your aliases created on other platforms into SimpleLogin.
        </div>
        <a href="{{ url_for('dashboard.batch_import_route') }}" class="btn btn-outline-primary">
          Batch Import
        </a>

      </div>
    </div> -->

    <div class="card">
      <div class="card-body">
        <div class="card-title">数据导出</div>
        <div class="mb-3">
          您可以下载在 原邮邮箱 上创建的所有别名以及其他数据。
        </div>

        <div class="d-flex">
          <div>
            <form method="post">
              <input type="hidden" name="form-name" value="export-data">
              <button class="btn btn-outline-info">导出数据</button>
            </form>
          </div>
          <div class="ml-5">
            <form method="post">
              <input type="hidden" name="form-name" value="export-alias">
              <button class="btn btn-outline-primary">导出别名</button>
            </form>
          </div>
        </div>


      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="card-title">删除帐户</div>
        <div class="mb-3">请注意，此操作不可逆。
        </div>

        <form method="post">
          <input type="hidden" name="form-name" value="delete-account">
          <span class="delete-account btn btn-outline-danger">删除账户</span>
        </form>
      </div>
    </div>

  </div>

{% endblock %}

{% block script %}
  <script>
    $(".delete-account").on("click", function (e) {
      let that = $(this);

      bootbox.confirm({
        message: "您的所有数据（包括您的别名）都将被删除，" +
                 "此后其他人可能无法联系到您，" +
                 "请确认。",
        buttons: {
          confirm: {
            label: '确认，删除我的账号',
            className: 'btn-danger'
          },
          cancel: {
            label: '取消',
            className: 'btn-outline-primary'
          }
        },
        callback: function (result) {
          if (result) {
            that.closest("form").submit();
          }
        }
      })

    });
  </script>
{% endblock %}

