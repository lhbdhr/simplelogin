{% extends 'default.html' %}
{% set active_page = "directory" %}

{% block title %}
  Directory
{% endblock %}

{% block default_content %}
  <div class="row">
    <div class="col">
      <h1 class="h3"> 目录
        <a class="ml-3 text-info" style="font-size: 12px" data-toggle="collapse" href="#howtouse" role="button"
           aria-expanded="false" aria-controls="collapseExample">
          如何使用 <i class="fe fe-chevrons-down"></i>
        </a>
      </h1>


      {% if not current_user.is_premium() %}
        <div class="alert alert-danger" role="alert">
          此功能仅在高级计划中可用。
        </div>
      {% endif %}

      <div class="alert alert-primary collapse {% if not dirs %} show {% endif %}" id="howtouse" role="alert">
        <div>
          目录允许您<b>动态</b>创建别名。
        </div>
        <div class="mt-2 pb-2">
          1️⃣ 为您的目录选择一个名称，例如 <em>my_directory</em> <br>

          2️⃣ 使用以下格式之一快速创建别名，<b>无需事先创建此别名</b>
        </div>
        <div class="pl-3 py-2 bg-secondary">
          <em>my_directory/<b>anything</b>@{{ FIRST_ALIAS_DOMAIN }}</em> 或者 <br>
          <em>my_directory+<b>anything</b>@{{ FIRST_ALIAS_DOMAIN }}</em> 或者 <br>
          <em>my_directory#<b>anything</b>@{{ FIRST_ALIAS_DOMAIN }}</em> <br>
        </div>
        <em><b>anything</b></em> 是任意由小写字符组成的字符串。<br>

        <div class="mt-2">
          您可以在以下域上使用此功能：
          {% for alias_domain in ALIAS_DOMAINS %}
            <div class="font-weight-bold">{{ alias_domain }} </div>
          {% endfor %}
        </div>

        <div class="h4 text-primary mt-3">
          ℹ️
          第一次收到电子邮件时将创建别名。
        </div>
        <br><br>
        <div class="">
          比如我创建了一个名叫 <em>admin</em> 的目录，然后我在注册<em>搬瓦工</em>需要填写邮箱时，<br>
          我可以填写 <em>admin+<b>bwg</b>@{{ FIRST_ALIAS_DOMAIN }}</em>，<br>
          然后这个别名就自动创建了，不用每次注册网站时，都需要登陆<em>www.yuanyou.de</em>来手动创建别名了。<br>
          这个自动创建的别名属于哪个用户，是根据这里创建的目录<em>admin</em>来决定的。<br>
          <em>bwg</em>只是个例子，你也可以不用注册网站名字，而是用任意的名字。但是你要自己能区分哪个别名是负责什么网站的。
        </div>
        
      </div>

      <div class="row">
        {% for dir in dirs %}
          <div class="col-12 col-lg-6">
            <div class="card" style="">
              <div class="card-body">
                <h5 class="card-title">
                  <div class="d-flex">
                    {{ dir.name }}

                    <form method="post">
                      <input type="hidden" name="form-name" value="toggle-directory">
                      <input type="hidden" name="dir-id" value="{{ dir.id }}">

                      <label class="custom-switch cursor" style="padding-left: 1rem"
                             data-toggle="tooltip"
                          {% if dir.disabled %}
                             title="启用目录动态别名创建"
                          {% else %}
                             title="禁用目录动态别名创建"
                          {% endif %}
                      >
                        <input type="checkbox" class="custom-switch-input" name="dir-status"
                            {{ "" if dir.disabled else "checked" }}>
                        <span class="custom-switch-indicator"></span>
                      </label>
                    </form>
                  </div>
                </h5>

                <h6 class="card-subtitle mb-2 text-muted">
                  {% if dir.disabled %}
                    <div class="mb-3">
                      ⚠️ 动态别名创建功能已禁用，您无法使用此目录创建新的别名。
                    </div>
                  {% endif %}
                  创建于 {{ dir.created_at | dt }} <br>
                  该目录内有<span class="font-weight-bold"> {{ dir.nb_alias() }}</span> 个别名.

                  <br><br>

                  <b>收件箱:</b> <i class="fe fe-info" data-toggle="tooltip"
                    title="使用此目录创建的别名将自动归这些邮箱所有"></i>
                  <br>

                  {% set dir_mailboxes=dir.mailboxes %}
                  <form method="post" class="mt-2">
                    <input type="hidden" name="form-name" value="update">
                    <input type="hidden" name="dir-id" value="{{ dir.id }}">

                    <select data-width="100%" required
                            class="mailbox-select" multiple name="mailbox_ids">
                      {% for mailbox in mailboxes %}
                        <option value="{{ mailbox.id }}" {% if mailbox in dir_mailboxes %}
                                selected {% endif %}>
                          {{ mailbox.email }}
                        </option>
                      {% endfor %}
                    </select>
                    <button class="mt-2 btn btn-outline-primary btn-sm">保存</button>
                  </form>
                </h6>
              </div>

              <div class="card-footer p-0">
                <div class="row">
                  <div class="col">
                    <form method="post">
                      <input type="hidden" name="form-name" value="delete">
                      <input type="hidden" class="dir-name" value="{{ dir.name }}">
                      <input type="hidden" name="dir-id" value="{{ dir.id }}">
                      <span class="card-link btn btn-link float-right text-danger delete-dir">
                    删除
                  </span>
                    </form>
                  </div>
                </div>

              </div>

            </div>
          </div>
        {% endfor %}
      </div>

      <div class="row">
        <div class="col">
          <div class="card">
            <div class="card-body">

              <form method="post" class="mt-2">
                {{ new_dir_form.csrf_token }}
                <input type="hidden" name="form-name" value="create">

                <h2 class="h4">创建目录</h2>

                {{ new_dir_form.name(class="form-control", placeholder="my-directory",
                  pattern="[0-9a-z-_]{3,}",
                  title="只能使用字母、数字、破折号 (-)、下划线 (_)。目录名称必须至少包含 3 个字符。") }}
                {{ render_field_errors(new_dir_form.name) }}
                <div class="small-text">
                  目录名称必须至少包含 3 个字符。
                  目前仅支持小写字母、数字、破折号 (-) 和下划线 (_)。
                </div>

                <div class="my-3 small-text alert alert-info">
                  默认情况下，使用目录创建的别名归您的默认邮箱 <b>{{ current_user.default_mailbox.email }}</b> 所有。<br>
                  但是，您可以通过设置以下选项来选择新别名自动所属的邮箱。
                </div>

                <select data-width="100%"
                        class="mailbox-select" multiple name="mailbox_ids">
                  {% for mailbox in mailboxes %}
                    <option value="{{ mailbox.id }}" {% if mailbox.id == current_user.default_mailbox_id %}
                            selected {% endif %}>
                      {{ mailbox.email }}
                    </option>
                  {% endfor %}
                </select>

                <button id="btn-create-directory" class="btn btn-lg btn-success mt-2">创建</button>
              </form>

            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
{% endblock %}

{% block script %}
  <script>
    $(".delete-dir").on("click", function (e) {
      let directory = $(this).parent().find(".dir-name").val();

      let that = $(this);
      let message = `与 <b>${directory} 目录关联的所有别名也将被删除, ` +
        "请确认";

      bootbox.confirm({
        message: message,
        buttons: {
          confirm: {
            label: '确认删除',
            className: 'btn-danger'
          },
          cancel: {
            label: '取消',
            className: 'btn-outline-primary'
          }
        },
        callback: function (result) {
          if (result) {
            that.closest("form").submit();
          }
        }
      })

    });

    $('.mailbox-select').multipleSelect();

    $(".custom-switch-input").change(function (e) {
      $(this).closest("form").submit();
    });

  </script>
{% endblock %}
