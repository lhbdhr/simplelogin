{% extends "default.html" %}

{% set active_page = "dashboard" %}
{% block title %}支持{% endblock %}
{% block default_content %}

  <div class="col pb-3">
    <div class="card">
      <div class="card-body">
        <div class="card-title mb-3">报告问题</div>
        <div class="alert alert-info">
          如果电子邮件无法送达您的邮箱，请检查
          <a href="{{ url_for("dashboard.notifications_route") }}">
            您的通知
          </a>
          如果遇到错误消息。
          <br />
          对于一般性问题，即与您的帐户无关的问题，我们建议将问题发布到
          我们的
          <a href="https://t.me/yuanyou_de">原邮邮箱官方TG交流群</a> 或 <a href="https://t.me/yuanyou_official">官方TG频道</a>
          我们的社区可以帮助回答问题
          并且其他有同样问题的人可以在那里找到答案。
        </div>
        <div class="alert alert-warning">
          Zendesk 中将创建一张支持单。请不要在单中包含任何敏感信息。
        </div>
        <form id="supportZendeskForm" method="post" enctype="multipart/form-data">
          <div class="mt-4 mb-5">
            <label for="issueDescription" class="form-label font-weight-bold">What happened?</label>
            <textarea class="form-control"
                      required
                      name="ticket_content"
                      id="issueDescription"
                      rows="3"
                      placeholder="Please provide as much information as possible. For example which alias(es), mailbox(es) are affected, if this is a persistent issue...">{{- ticket_content or '' -}}</textarea>
          </div>
          <div class="mt-5 font-weight-bold">Attach files to support request</div>
          <div class="text-muted">Only images, text and emails are accepted</div>
          <div class="custom-file">
            <input type="file"
                   class="custom-file-input"
                   name="ticket_files"
                   id="ticketFileGroup"
                   multiple="multiple">
            <label class="custom-file-label" for="ticketFileGroup">Choose file</label>
          </div>
          <div class="mt-5 font-weight-bold">Where can we reach you?</div>
          <div class="text-muted">
            Conversations related to this ticket will be sent to this address. Feel free to use an alias here.
          </div>
          <div class="input-group mb-3" id="alias-group">
            <input type="text"
                   required
                   class="form-control"
                   placeholder="Email"
                   name="ticket_email"
                   v-model='ticket_email'
                   aria-label="Email to send responses to"
                   aria-describedby="button-addon2">
            <div class="input-group-append">
              <button class="btn btn-outline-primary"
                      type="button"
                      @click="generateRandomAlias"
                      id="button-addon2">Generate a random alias</button>
            </div>
          </div>
          <div class="mt-5">
            <button class="btn btn-primary">Create support ticket</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}
{% block script %}

  <script>
    new Vue({
      el: '#alias-group',
      data: {
        ticket_email: '{{ ticket_email }}'
      },
      methods: {
        generateRandomAlias: async function (event) {
          let result = await fetch('/api/alias/random/new', {method: 'POST',
              headers: {
              '{{HEADER_ALLOW_API_COOKIES}}': 'allow'
          }});
          if (result.ok) {
            let data = await result.json();
            this.ticket_email = data.alias;
          } else if (result.status === 429 ){
              toastr.warning("You've created too many aliases recently. Wait a bit before creating more");
          } else {
              toastr.warning("You can't create more aliases");
          }
        }
      }
    });

    $('.custom-file input').change(function (e) {
      let files = [];
      for (let i = 0; i < $(this)[0].files.length; i++) {
        files.push($(this)[0].files[i].name);
      }
      $(this).next('.custom-file-label').html(files.join(', '));
    });
  </script>
{% endblock %}
