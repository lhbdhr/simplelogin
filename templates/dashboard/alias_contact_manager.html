{% extends "default.html" %}

{% set active_page = "dashboard" %}
{% block title %}è”ç³»äººç®¡â€‹â€‹ç†{% endblock %}
{% block default_content %}

  <div class="row">
    <div class="col">
      <h1 class="h3">
        {{ alias.email }} çš„è”ç³»äºº
        <a class="ml-3 text-info"
           style="font-size: 12px"
           data-toggle="collapse"
           href="#howtouse"
           role="button"
           aria-expanded="false"
           aria-controls="collapseExample">
          å¦‚ä½•ä½¿ç”¨ <i class="fe fe-chevrons-down"></i>
        </a>
      </h1>
      <div class="collapse" id="howtouse" role="alert">
        <div class="alert alert-primary">
          <p>
            ä½ æƒ³è¦ä»ä½ çš„åˆ«åï¼Œç»™åˆ«äººå‘é€ç”µå­é‚®ä»¶ï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ª<em>åå‘åˆ«å</em>ï¼Œå³
            ä¸€ä¸ªç‰¹æ®Šçš„ç”µå­é‚®ä»¶åœ°å€ã€‚
            <br>
            å½“ä½ ç”¨è‡ªå·±çš„çœŸå®é‚®ç®±ï¼Œå‘åå‘åˆ«åå‘é€ç”µå­é‚®ä»¶æ—¶ï¼Œè¯¥ç”µå­é‚®ä»¶å°†<b>ä»ä½ çš„åˆ«å</b>å‘é€åˆ°è”ç³»äººã€‚
            <br>
          </p>
          <p>
            {% if alias.mailbox_id %}
              {% if alias.mailboxes | length == 1 %}

                <p style="color: red;">
                  æ³¨æ„ï¼šè¿™é‡Œæœ‰ä¸€ä¸ªé™åˆ¶ã€‚ä¸ç„¶åˆ«äººçŸ¥é“äº†ä½ çš„åå‘åˆ«åï¼Œè°éƒ½å¯ä»¥å†’å……ä½ äº†ã€‚
                  <p>
                    é™åˆ¶ï¼šä¸€å®šè¦ä»é‚®ç®± <em>{{ alias.mailbox.email }}</em> å‘é€ç”µå­é‚®ä»¶ã€‚å¦åˆ™ä¼šè¢«æœ¬ç½‘ç«™æ‹’æ”¶ã€‚
                  {% else %}
                    <p style="color: red;">
                      æ³¨æ„ï¼šè¿™é‡Œæœ‰ä¸€ä¸ªé™åˆ¶ã€‚ä¸ç„¶åˆ«äººçŸ¥é“äº†ä½ çš„åå‘åˆ«åï¼Œè°éƒ½å¯ä»¥å†’å……ä½ äº†ã€‚
                      <p>
                        é™åˆ¶ï¼šä¸€å®šè¦ä»ä»¥ä¸‹é‚®ç®±ä¹‹ä¸€å‘é€ç”µå­é‚®ä»¶ï¼š
                        <br>
                        {% for mailbox in alias.mailboxes %}

                          - <b>{{ mailbox.email }}</b>
                          <br>
                        {% endfor %}
                      {% endif %}
                    {% else %}
                      <p style="color: red;">æ³¨æ„ï¼šè¿™é‡Œæœ‰ä¸€ä¸ªé™åˆ¶ã€‚ä¸ç„¶åˆ«äººçŸ¥é“äº†ä½ çš„åå‘åˆ«åï¼Œè°éƒ½å¯ä»¥å†’å……ä½ äº†ã€‚</p>
                      é™åˆ¶ï¼šç¡®ä¿ä»ä¸ªäººç”µå­é‚®ä»¶åœ°å€å‘é€ç”µå­é‚®ä»¶ ({{ current_user.email }}).
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% if can_create_contacts %}

              <div class="row mb-5">
                <div class="col-12 col-md-6 pt-1">
                  <form method="post">
                    <input type="hidden" name="form-name" value="create" />
                    {{ new_contact_form.csrf_token }}
                    {{ new_contact_form.email(class="form-control", placeholder="å å§“ <email@example.com> æˆ–è€… ç›´æ¥å¡«å†™é‚®ç®±åœ°å€ä¹Ÿå¯ä»¥", autofocus=True) }}
                    {{ render_field_errors(new_contact_form.email) }}
                    <div class="small-text mt-2">æ‚¨æƒ³å°†ç”µå­é‚®ä»¶å‘é€åˆ°å“ªé‡Œï¼Ÿ</div>
                    {% if can_create_contacts %}

                      <button class="btn btn-primary mt-2">åˆ›å»ºåå‘åˆ«åé‚®ç®±</button>
                    {% else %}
                      <button disabled title="å‡çº§åˆ°é«˜çº§ç‰ˆä»¥åˆ›å»ºåå‘åˆ«å" class="btn btn-primary mt-2">åˆ›å»ºåå‘åˆ«åé‚®ç®±</button>
                    {% endif %}
                  </form>
                </div>
              {% endif %}
              <div class="col-12 col-md-6 pt-1 d-none d-sm-block">
                <div class="float-right d-flex">
                  <form method="post">
                    {{ csrf_form.csrf_token }}
                    <input type="hidden" name="form-name" value="search">
                    <input type="search"
                           name="query"
                           value="{{ query }}"
                           placeholder="è¾“å…¥ä»¥æœç´¢è”ç³»äºº"
                           class="form-control shadow mr-2"
                           style="max-width: 20em">
                  </form>
                  {% if query %}
                    {% if highlight_contact_id %}

                      <a href="{{ url_for("dashboard.alias_contact_manager", alias_id=alias.id, highlight_contact_id=highlight_contact_id) }}"
                         class="btn btn-light">é‡ç½®</a>
                    {% else %}
                      <a href="{{ url_for("dashboard.alias_contact_manager", alias_id=alias.id) }}"
                         class="btn btn-light">é‡ç½®</a>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="row">
              {% for contact_info in contact_infos %}

                {% set contact = contact_info.contact %}
                <div class="col-md-6">
                  <div class="my-2 p-2 card {% if contact.id == highlight_contact_id %}highlight-row{% endif %}">
                    <div class="mb-2 row">
                      <div class="col">
                        <span class="font-weight-bold">{{ contact.website_email }}</span>
                        {% if contact.pgp_finger_print %}

                          <span class="cursor" data-toggle="tooltip" data-original-title="PGP å·²å¯ç”¨">ğŸ—</span>
                        {% endif %}
                      </div>
                      <div class="col text-right">
                        <label class="custom-switch cursor" data-toggle="tooltip" {% if contact.block_forward %}
                           title="è§£é™¤é˜»æ­¢å‘ä»¶äºº - å¼€å§‹æ¥æ”¶æ¥è‡ªæ­¤å‘ä»¶äººçš„ç”µå­é‚®ä»¶" {% else %} title="é˜»æ­¢å‘ä»¶äºº - åœæ­¢æ¥æ”¶æ¥è‡ªæ­¤å‘ä»¶äººçš„ç”µå­é‚®ä»¶" {% endif %} style="padding-left: 0px">
                          <input type="checkbox" class="enable-disable-contact custom-switch-input" data-contact="{{ contact.id }}" data-contact-email="{{ contact.website_email }}" {{ "checked" if not contact.block_forward else "" }}>
                          <span class="custom-switch-indicator"></span>
                        </label>
                      </div>
                    </div>
                    <div>
                      <span>
                        <a href="{{ 'mailto:' + contact.website_send_to() }}"
                           target="_blank"
                           data-toggle="tooltip"
                           title="æ‚¨å¯ä»¥å•å‡»æ­¤å¤„æ‰“å¼€æ‚¨çš„ç”µå­é‚®ä»¶å®¢æˆ·ç«¯ã€‚æˆ–è€…ä½¿ç”¨å¤åˆ¶æŒ‰é’® ğŸ‘‰"
                           class="font-weight-bold">*************************</a>
                        <span class="clipboard btn btn-sm btn-success copy-btn"
                              data-toggle="tooltip"
                              title="å¤åˆ¶åå‘åˆ«åé‚®ç®±åœ°å€"
                              data-clipboard-text="{{ contact.website_send_to() }}">å¤åˆ¶åå‘åˆ«åé‚®ç®±åœ°å€</span>
                      </span>
                    </div>
                    <div class="mb-2 text-muted small-text">
                      {% if contact_info.latest_email_log != None %}

                        {% set email_log = contact_info.latest_email_log %}
                        {% if email_log.is_reply %}

                          <i class="fa fa-reply mr-2" data-toggle="tooltip" title="ç”µå­é‚®ä»¶å›å¤/ä»åˆ«åå‘é€"></i>
                          {{ email_log.created_at | dt }}
                        {% elif email_log.bounced %}
                          <span class="text-danger">
                            <i class="fa fa-warning mr-2"
                               data-toggle="tooltip"
                               title="ç”µå­é‚®ä»¶è¢«é€€å›ï¼Œæ— æ³•è½¬å‘è‡³æ‚¨çš„é‚®ç®±"></i>
                            {{ email_log.created_at | dt }}
                          </span>
                        {% elif email_log.blocked %}
                          <i class="fa fa-ban mr-2 text-danger"
                             data-toggle="tooltip"
                             title="ç”µå­é‚®ä»¶è¢«é˜»æ­¢"></i>
                          {{ email_log.created_at | dt }}
                        {% else %}
                          <i class="fa fa-paper-plane  mr-2"
                             data-toggle="tooltip"
                             title="ç”µå­é‚®ä»¶å·²å‘é€è‡³åˆ«å"></i>
                          {{ email_log.created_at | dt }}
                        {% endif %}
                        <br />
                        å·²åˆ›å»ºè”ç³»äºº {{ contact.created_at | dt }}
                      {% else %}
                        è¿‡å» 14 å¤©å†…æ— æ´»åŠ¨ã€‚è”ç³»äººåˆ›å»ºäº {{ contact.created_at | dt }}
                      {% endif %}
                      <div>
                        <span class="alias-activity">{{ contact_info.nb_forward }}</span> ä¸ªè½¬å‘,
                        <span class="alias-activity">{{ contact_info.nb_reply }}</span> ä¸ªå‘é€ ( 14å¤©å†… )
                      </div>
                    </div>
                    <a href="{{ url_for('dashboard.contact_detail_route', contact_id=contact.id) }}">ç¼–è¾‘ â¡</a>
                    <form method="post">
                      {{ csrf_form.csrf_token }}
                      <input type="hidden" name="form-name" value="delete">
                      <input type="hidden" name="contact-id" value="{{ contact.id }}">
                      <span class="card-link btn btn-link float-right delete-forward-email text-danger">åˆ é™¤</span>
                    </form>
                  </div>
                </div>
              {% endfor %}
            </div>
            {% if nb_contact > PAGE_LIMIT or page > 0 %}

              <div class="row mt-3">
                <div class="col">
                  <nav aria-label="Contact navigation">
                    <ul class="pagination">
                      <li class="page-item mr-2">
                        <a class="btn btn-outline-secondary {% if page == 0 %}disabled{% endif %}" href="{{ url_for('dashboard.alias_contact_manager', alias_id=alias.id, page=page-1) }}">
                          ä¸Šä¸€é¡µ
                        </a>
                      </li>
                      <li class="page-item">
                        <a class="btn btn-outline-secondary {% if last_page %}disabled{% endif %}" href="{{ url_for('dashboard.alias_contact_manager', alias_id=alias.id, page=page+1) }}">
                          ä¸‹ä¸€é¡µ
                        </a>
                      </li>
                    </ul>
                  </nav>
                </div>
              </div>
            {% endif %}
          {% endblock %}
          {% block script %}

            <script>
    $(".delete-forward-email").on("click", function (e) {
      let that = $(this);

      bootbox.confirm({
        message: "ä¸æ­¤è”ç³»äººç›¸å…³çš„æ‰€æœ‰æ´»åŠ¨ä¹Ÿå°†è¢«åˆ é™¤ï¼Œè¯·ç¡®è®¤ã€‚",
        buttons: {
          confirm: {
            label: 'ç¡®è®¤åˆ é™¤',
            className: 'btn-danger'
          },
          cancel: {
            label: 'å–æ¶ˆ',
            className: 'btn-outline-primary'
          }
        },
        callback: function (result) {
          if (result) {
            that.closest("form").submit();
          }
        }
      })
    });

    $(".enable-disable-contact").change(async function () {
      let contactID = $(this).data("contact");
      let contactEmail = $(this).data("contact-email");

      await blockContact(contactID, contactEmail);
    })

    async function blockContact(contactID, contactEmail) {
      let oldValue;
      try {
        let res = await fetch(`/api/contacts/${contactID}/toggle`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
              '{{HEADER_ALLOW_API_COOKIES}}': 'allow'
          }
        });

        if (res.ok) {
          let json = await res.json();

          if (json.block_forward) {
            toastr.success(`${contactEmail} å·²ç»ç¦ç”¨`);
          } else {
            toastr.success(`${contactEmail} å·²ç»å¯ç”¨`);
          }
        } else {
          toastr.error("æŠ±æ­‰é€ æˆä¸ä¾¿ï¼æ‚¨å¯ä»¥åˆ·æ–°é¡µé¢å¹¶é‡è¯•å—ï¼Ÿ", "æœªçŸ¥é”™è¯¯");
          // reset to the original value
          oldValue = !$(this).prop("checked");
          $(this).prop("checked", oldValue);
        }
      } catch (e) {
        toastr.error("æŠ±æ­‰é€ æˆä¸ä¾¿ï¼æ‚¨å¯ä»¥åˆ·æ–°é¡µé¢å¹¶é‡è¯•å—ï¼Ÿ", "æœªçŸ¥é”™è¯¯");
        // reset to the original value
        oldValue = !$(this).prop("checked");
        $(this).prop("checked", oldValue);
      }
    }
            </script>
          {% endblock %}
