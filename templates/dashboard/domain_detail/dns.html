{% extends "dashboard/domain_detail/base.html" %}

{% set domain_detail_page = "dns" %}
{% block title %}{{ custom_domain.domain }} DNS{% endblock %}
{% block domain_detail_content %}

          <script>
            console.log("ownership_ok {{ownership_ok}}")
            console.log("mx_ok {{mx_ok}}")
            console.log("spf_ok {{spf_ok}}")
            console.log("dkim_ok {{dkim_ok}}")
            console.log("dmarc_ok {{dmarc_ok}}")
            console.log("custom_domain.ownership_verified {{custom_domain.ownership_verified}}")
            console.log("custom_domain.verified {{custom_domain.verified}}")
            console.log("custom_domain.spf_verified {{custom_domain.spf_verified}}")
            console.log("custom_domain.dkim_verified {{custom_domain.dkim_verified}}")
            console.log("custom_domain.dmarc_verified {{custom_domain.dmarc_verified}}")
          </script>

  <div class="p-4 mr-auto" style="max-width: 60rem;">
    <h1 class="h2">{{ custom_domain.domain }}</h1>
    <div>è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è®¾ç½®æ‚¨çš„åŸŸåã€‚</div>
    <div class="small-text mb-5">DNS æ›´æ”¹å¯èƒ½éœ€è¦æœ€å¤š 24 å°æ—¶æ‰èƒ½æ›´æ–°ã€‚</div>
    {% if not custom_domain.ownership_verified %}

      <div id="ownership-form">
        <div class="font-weight-bold">
          åŸŸåæ‰€æœ‰æƒéªŒè¯
          {% if custom_domain.ownership_verified %}

            <span class="cursor"
                  data-toggle="tooltip"
                  data-original-title="åŸŸåæ‰€æœ‰æƒå·²éªŒè¯">âœ…</span>
          {% else %}
            <span class="cursor"
                  data-toggle="tooltip"
                  data-original-title="éœ€è¦éªŒè¯åŸŸåæ‰€æœ‰æƒ">ğŸš«</span>
          {% endif %}
        </div>
        {% if not custom_domain.ownership_verified %}

          <div class="mb-2">
            è¦éªŒè¯åŸŸåæ‰€æœ‰æƒï¼Œè¯·æ·»åŠ ä»¥ä¸‹ TXT è®°å½•ã€‚
            <br />
            æŸäº›åŸŸåæ³¨å†Œå•†ï¼ˆNamecheap/CloudFlare ç­‰ï¼‰å¯èƒ½ä¼šä½¿ç”¨ <em>@</em> ä½œä¸ºæ ¹åŸŸã€‚
          </div>
          <div class="mb-3 p-3 dns-record">
            è®°å½•ç±»å‹: TXT
            <br />
            è®°å½•åç§°: <em data-toggle="tooltip"
            title="ç‚¹å‡»å¤åˆ¶"
            class="clipboard"
            data-clipboard-text="{{ custom_domain.domain }}">{{ custom_domain.domain }}</em> æˆ–è€… <em data-toggle="tooltip"
            title="ç‚¹å‡»å¤åˆ¶"
            class="clipboard"
            data-clipboard-text="@">@</em>
            <br />
            è®°å½•å€¼: <em data-toggle="tooltip"
            title="ç‚¹å‡»å¤åˆ¶"
            class="clipboard"
            data-clipboard-text="{{ ownership_records.recommended }}">{{ ownership_records.recommended }}</em>
          </div>
          <form method="post" action="#ownership-form">
            {{ csrf_form.csrf_token }}
            <input type="hidden" name="form-name" value="check-ownership">
            <button type="submit" class="btn btn-primary">éªŒè¯</button>
          </form>
          {% if not ownership_ok %}
            <div class="text-danger mt-4">
              æ‚¨çš„ DNS è®¾ç½®ä¸æ­£ç¡®ã€‚æˆ‘ä»¬è·å–çš„ TXT è®°å½•æ˜¯ï¼š
              <div class="mb-3 p-3 dns-record">
                {% if not ownership_errors %}(Empty){% endif %}
                {% for r in ownership_errors %}
                  {{ r }}
                  <br />
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      {% endif %}
      <hr />
    {% endif %}
    <div class="{% if not custom_domain.ownership_verified %}
       disabled-content{% endif %}" id="dns-setup">
      {% if not custom_domain.ownership_verified %}

        <div class="alert alert-warning">é¦–å…ˆå¿…é¡»éªŒè¯åŸŸåæ‰€æœ‰æƒã€‚</div>
      {% endif %}
      <div id="mx-form">
        <div class="font-weight-bold">
          1. MX è®°å½•
          {% if custom_domain.verified %}
            <span class="cursor"
                  data-toggle="tooltip"
                  data-original-title="MX è®°å½•å·²éªŒè¯">âœ…</span>
          {% else %}
            <span class="cursor"
                  data-toggle="tooltip"
                  data-original-title="MX è®°å½•æœªéªŒè¯">ğŸš«</span>
          {% endif %}
        </div>
        <div class="mb-2">
          å°†ä»¥ä¸‹ MX DNS è®°å½•æ·»åŠ åˆ°æ‚¨çš„åŸŸã€‚
          <br />
          è¯·æ³¨æ„ï¼Œç›®æ ‡åœ°å€æœ«å°¾æœ‰ä¸€ä¸ªç‚¹ (<em>.</em>)ã€‚
          <br />
          å¦‚æœæ‚¨çš„åŸŸåæ³¨å†Œå•†ä¸å…è®¸ä½¿ç”¨æ­¤å°¾éšç‚¹ï¼Œè¯·åœ¨æ·»åŠ  DNS è®°å½•æ—¶å°†å…¶åˆ é™¤ã€‚
          <br />
          ä¸€äº›åŸŸåæ³¨å†Œå•†ï¼ˆNamecheap/CloudFlare ç­‰ï¼‰å¯èƒ½è¿˜ä¼šå°† <em>@</em> ç”¨äºæ ¹åŸŸã€‚
        </div>
        {% for prio in expected_mx_records %}

          <div class="mb-3 p-3 dns-record">
            è®°å½•ç±»å‹: MX
            <br />
            è®°å½•åç§°:  <em data-toggle="tooltip"
            title="ç‚¹å‡»å¤åˆ¶"
            class="clipboard"
            data-clipboard-text="{{ custom_domain.domain }}">{{ custom_domain.domain }}</em> æˆ–è€…
            <em data-toggle="tooltip"
            title="ç‚¹å‡»å¤åˆ¶"
            class="clipboard"
            data-clipboard-text="@">@</em>
            <br />
            ä¼˜å…ˆçº§: {{ prio }}
            <br />
            è®°å½•å€¼: <em data-toggle="tooltip"
            title="ç‚¹å‡»å¤åˆ¶"
            class="clipboard"
            data-clipboard-text="{{ expected_mx_records[prio].recommended }}">{{ expected_mx_records[prio].recommended }}</em>
          </div>
        {% endfor %}
        <form method="post" action="#mx-form">
          {{ csrf_form.csrf_token }}
          <input type="hidden" name="form-name" value="check-mx">
          {% if custom_domain.verified %}
            <button type="submit" class="btn btn-outline-primary">é‡æ–°éªŒè¯</button>
          {% else %}
            <button type="submit" class="btn btn-primary">éªŒè¯</button>
          {% endif %}
        </form>
        {% if not mx_ok %}

          <div class="text-danger mt-4">
            æ‚¨çš„ DNS è®¾ç½®ä¸æ­£ç¡®ã€‚æˆ‘ä»¬è·å–çš„ MX è®°å½•æ˜¯ï¼š
            <div class="mb-3 p-3 dns-record">
              {% if not mx_errors %}(Empty){% endif %}
              {% for r in mx_errors %}
                {{ r }}
                <br />
              {% endfor %}
            </div>
            {% if not custom_domain.verified %}
              <div class="alert alert-danger">
                å¦‚æœæœªæ­£ç¡®è®¾ç½® MX è®°å½•ï¼Œæ‚¨å¯èƒ½ä¼šé”™è¿‡å‘é€è‡³åˆ«åçš„ç”µå­é‚®ä»¶ã€‚è¯·å°½å¿«æ›´æ–° MX è®°å½•ã€‚
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
      <hr />
      <div id="spf-form">
        <div class="font-weight-bold">
          2. SPF (å¯é€‰é¡¹)
          {% if custom_domain.spf_verified %}

            <span class="cursor"
                  data-toggle="tooltip"
                  data-original-title="SPF å·²éªŒè¯">âœ…</span>
          {% else %}
            <span class="cursor"
                  data-toggle="tooltip"
                  data-original-title="SPF æœªéªŒè¯">ğŸš«</span>
          {% endif %}
        </div>
        <div>
          SPF
          <a href="https://en.wikipedia.org/wiki/Sender_Policy_Framework"
             target="_blank"
             rel="noopener noreferrer">(Wikipediaâ†—)</a>
          æ˜¯ä¸€ç§ç”µå­é‚®ä»¶èº«ä»½éªŒè¯æ–¹æ³•ï¼Œæ—¨åœ¨æ£€æµ‹ç”µå­é‚®ä»¶ä¼ é€’è¿‡ç¨‹ä¸­ä¼ªé€ çš„å‘ä»¶äººåœ°å€ã€‚
          <br />
          å¼ºçƒˆå»ºè®®è®¾ç½® SPFï¼Œä»¥å‡å°‘æ‚¨çš„ç”µå­é‚®ä»¶æœ€ç»ˆè¿›å…¥æ”¶ä»¶äººåƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹çš„æœºä¼šã€‚
        </div>
        <div class="mb-2">å°†ä»¥ä¸‹ TXT DNS è®°å½•æ·»åŠ åˆ°æ‚¨çš„åŸŸã€‚</div>
        <div class="mb-2 p-3 dns-record">
          è®°å½•ç±»å‹: TXT
          <br />
          è®°å½•åç§°: <em data-toggle="tooltip"
            title="ç‚¹å‡»å¤åˆ¶"
            class="clipboard"
            data-clipboard-text="{{ custom_domain.domain }}">{{ custom_domain.domain }}</em> æˆ–è€… <em data-toggle="tooltip"
            title="ç‚¹å‡»å¤åˆ¶"
            class="clipboard"
            data-clipboard-text="@">@</em>
          <br />
          è®°å½•å€¼:
          <em data-toggle="tooltip"
              title="ç‚¹å‡»å¤åˆ¶"
              class="clipboard"
              data-clipboard-text="{{ spf_record }}">{{ spf_record }}</em>
        </div>
        <form method="post" action="#spf-form">
          {{ csrf_form.csrf_token }}
          <input type="hidden" name="form-name" value="check-spf">
          {% if custom_domain.spf_verified %}

            <button type="submit" class="btn btn-outline-primary">é‡æ–°éªŒè¯</button>
          {% else %}
            <button type="submit" class="btn btn-primary">éªŒè¯</button>
          {% endif %}
        </form>
        {% if not spf_ok %}

          <div class="text-danger mt-4">
            æ‚¨çš„ DNS è®¾ç½®ä¸æ­£ç¡®ã€‚æˆ‘ä»¬è·å–çš„ TXT è®°å½•æ˜¯ï¼š
            <div class="mb-3 p-3 dns-record">
              {% if not spf_errors %}(Empty){% endif %}
              {% for r in spf_errors %}
                {{ r }}
                <br />
              {% endfor %}
            </div>
            {% if not custom_domain.spf_verified %}
            <div class="alert alert-danger">
              å¦‚æœæ²¡æœ‰è®¾ç½® SPFï¼Œæ‚¨ä»åˆ«åå‘é€çš„ç”µå­é‚®ä»¶å¯èƒ½ä¼šè¿›å…¥åƒåœ¾é‚®ä»¶/åƒåœ¾æ–‡ä»¶å¤¹ã€‚
            </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
      <hr />
      <div id="dkim-form">
        <div class="font-weight-bold">
          3. DKIM (å¯é€‰é¡¹)
          {% if custom_domain.dkim_verified %}

            <span class="cursor"
                  data-toggle="tooltip"
                  data-original-title="SPF å·²éªŒè¯">âœ…</span>
          {% else %}
            <span class="cursor"
                  data-toggle="tooltip"
                  data-original-title="DKIM æœªéªŒè¯">ğŸš«</span>
          {% endif %}
        </div>
        <div>
          DKIM
          <a href="https://en.wikipedia.org/wiki/DomainKeys_Identified_Mail"
             target="_blank"
             rel="noopener noreferrer">(Wikipediaâ†—)</a>
          æ˜¯ä¸€ç§ç”µå­é‚®ä»¶èº«ä»½éªŒè¯æ–¹æ³•ï¼Œæ—¨åœ¨é¿å…ç”µå­é‚®ä»¶æ¬ºéª—ã€‚
          <br />
          å¼ºçƒˆå»ºè®®è®¾ç½® DKIMï¼Œä»¥å‡å°‘æ‚¨çš„ç”µå­é‚®ä»¶æœ€ç»ˆè¿›å…¥æ”¶ä»¶äººåƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹çš„æœºä¼šã€‚
          </div>
          <div class="mb-2">å°†ä»¥ä¸‹ CNAME DNS è®°å½•æ·»åŠ åˆ°æ‚¨çš„åŸŸã€‚</div>
        {% for dkim_prefix, dkim_cname_value in dkim_records.items() %}

          <div class="mb-2 p-3 dns-record">
            è®°å½•ç±»å‹: CNAME
            <br />
            è®°å½•åç§°: <em data-toggle="tooltip"
              title="ç‚¹å‡»å¤åˆ¶"
              class="clipboard"
              data-clipboard-text="{{ dkim_prefix }}">{{ dkim_prefix }}</em>
            <br />
            è®°å½•å€¼:
            <em data-toggle="tooltip"
                title="ç‚¹å‡»å¤åˆ¶"
                class="clipboard"
                data-clipboard-text="{{ dkim_cname_value.recommended }}."
                style="overflow-wrap: break-word">{{ dkim_cname_value.recommended }}.</em>
          </div>
        {% endfor %}
        <div class="alert alert-info">
          æŸäº› DNS æ³¨å†Œå•†å¯èƒ½éœ€è¦å®Œæ•´çš„è®°å½•è·¯å¾„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·ä½¿ç”¨
          <i>dkim._domainkey.{{ custom_domain.domain }}</i> ä½œä¸ºåŸŸå€¼ã€‚
          <br />
          å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯å­åŸŸï¼Œä¾‹å¦‚ <i>subdomain.domain.com</i>ï¼Œ
          åˆ™éœ€è¦ä½¿ç”¨ <i>dkim._domainkey.subdomain.domain.com</i> ä½œä¸ºåŸŸã€‚
          <br />
          è¿™æ„å‘³ç€ï¼Œå¦‚æœæ‚¨çš„åŸŸæ˜¯ <i>mail.domain.com</i>ï¼Œæ‚¨åº”è¯¥è¾“å…¥ <i>dkim._domainkey.mail.domain.com</i> ä½œä¸ºåŸŸã€‚
          <br />
        </div>
        <div class="alert alert-info">
          å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ CloudFlareï¼Œè¯·ç¡®ä¿<b>ä¸è¦</b>é€‰æ‹©ä»£ç†é€‰é¡¹ã€‚
          <br />
          <br />
          <img src="/static/images/cloudflare-proxy.png" class="w-100">
        </div>
        <form method="post" action="#dkim-form">
          {{ csrf_form.csrf_token }}
          <input type="hidden" name="form-name" value="check-dkim">
          {% if custom_domain.dkim_verified %}
            <button type="submit" class="btn btn-outline-primary">é‡æ–°éªŒè¯</button>
          {% else %}
            <button type="submit" class="btn btn-primary">éªŒè¯</button>
          {% endif %}
        </form>
        {% if not dkim_ok %}
          <div class="text-danger mt-4">
            <p class="mb-0">æ‚¨çš„ DNS è®¾ç½®ä¸æ­£ç¡®ã€‚</p>
            <ul class="dns-record">
              {% for custom_record, retrieved_cname in dkim_errors.items() %}
                <li>
                  æˆ‘ä»¬è·å–çš„ CNAME è®°å½• <em>{{ custom_record }}</em> çš„å€¼æ˜¯ {{ retrieved_cname }}
                </li>
              {% endfor %}
            </ul>
          </div>
          {% if not custom_domain.dkim_verified %}
            <div class="alert alert-danger">
              å¦‚æœæ²¡æœ‰è®¾ç½® DKIMï¼Œæ‚¨ä»åˆ«åå‘é€çš„ç”µå­é‚®ä»¶å¯èƒ½ä¼šè¿›å…¥åƒåœ¾é‚®ä»¶/åƒåœ¾æ–‡ä»¶å¤¹ã€‚
            </div>
          {% endif %}
      </div>
    {% endif %}
      <hr />
      <div id="dmarc-form">
        <div class="font-weight-bold">
          4. DMARC (å¯é€‰é¡¹)
          {% if custom_domain.dmarc_verified %}

            <span class="cursor"
                  data-toggle="tooltip"
                  data-original-title="DMARC å·²éªŒè¯">âœ…</span>
          {% else %}
            <span class="cursor"
                  data-toggle="tooltip"
                  data-original-title="DMARC æœªéªŒè¯">ğŸš«</span>
          {% endif %}
        </div>
        <div>
          DMARC
          <a href="https://en.wikipedia.org/wiki/DMARC"
             target="_blank"
             rel="noopener noreferrer">(Wikipediaâ†—)</a>
          æ—¨åœ¨ä¿æŠ¤åŸŸåå…é­æœªç»æˆæƒçš„ä½¿ç”¨ï¼Œå³é€šå¸¸æ‰€è¯´çš„ç”µå­é‚®ä»¶æ¬ºéª—ã€‚
          <br />
          DMARC ç­–ç•¥ä»¥ SPF å’Œ DKIM ä¸ºåŸºç¡€ï¼Œ
          <br />
          å®ƒä¼šå‘Šè¯‰æ¥æ”¶é‚®ä»¶æœåŠ¡å™¨å¦‚æœè¿™ä¸¤ç§èº«ä»½éªŒè¯æ–¹æ³•éƒ½æ— æ³•é€šè¿‡ï¼Œåº”è¯¥é‡‡å–ä»€ä¹ˆæªæ–½ã€‚
        </div>
        <div class="mb-2">å°†ä»¥ä¸‹ TXT DNS è®°å½•æ·»åŠ åˆ°æ‚¨çš„åŸŸã€‚</div>
        <div class="mb-2 p-3 dns-record">
          è®°å½•ç±»å‹: TXT
          <br />
          è®°å½•å†…å®¹: <em data-toggle="tooltip"
            title="ç‚¹å‡»å¤åˆ¶"
            class="clipboard"
            data-clipboard-text="_dmarc">_dmarc</em>
          <br />
          è®°å½•å€¼:
          <em data-toggle="tooltip"
              title="ç‚¹å‡»å¤åˆ¶"
              class="clipboard"
              data-clipboard-text="{{ dmarc_record }}">{{ dmarc_record }}</em>
        </div>
        <div class="alert alert-info">
         æŸäº› DNS æ³¨å†Œå•†å¯èƒ½éœ€è¦å®Œæ•´çš„è®°å½•è·¯å¾„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·ä½¿ç”¨
        <i>_dmarc.{{ custom_domain.domain }}<i> ä½œä¸ºåŸŸå€¼ã€‚
        <br />
        å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯å­åŸŸï¼Œä¾‹å¦‚ <i>subdomain.domain.com</i>ï¼Œ
        åˆ™éœ€è¦ä½¿ç”¨ <i>_dmarc.subdomain.domain.com</i> ä½œä¸ºåŸŸå€¼ã€‚
        <br />
        </div>
        <form method="post" action="#dmarc-form">
          {{ csrf_form.csrf_token }}
          <input type="hidden" name="form-name" value="check-dmarc">
          {% if custom_domain.dmarc_verified %}

            <button type="submit" class="btn btn-outline-primary">é‡æ–°éªŒè¯</button>
          {% else %}
            <button type="submit" class="btn btn-primary">éªŒè¯</button>
          {% endif %}
        </form>
        {% if not dmarc_ok %}
          <div class="text-danger mt-4">
            æ‚¨çš„ DNS è®¾ç½®ä¸æ­£ç¡®ã€‚æˆ‘ä»¬è·å–çš„ TXT è®°å½•æ˜¯ï¼š
            <div class="mb-3 p-3 dns-record">
              {% if not dmarc_errors %}(Empty){% endif %}
              {% for r in dmarc_errors %}
                {{ r }}
                <br />
              {% endfor %}
            </div>
            {% if not custom_domain.dmarc_verified %}
              <div class="alert alert-danger">
                å¦‚æœæ²¡æœ‰è®¾ç½® DMARCï¼Œä»æ‚¨çš„åˆ«åå‘é€çš„ç”µå­é‚®ä»¶å¯èƒ½ä¼šè¿›å…¥åƒåœ¾é‚®ä»¶/åƒåœ¾æ–‡ä»¶å¤¹ã€‚
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}
