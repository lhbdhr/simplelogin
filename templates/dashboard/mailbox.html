{% extends "default.html" %}

{% set active_page = "mailbox" %}
{% block title %}æ”¶ä»¶é‚®ç®±{% endblock %}
{% block default_content %}

  <div class="row">
    <div class="col">
      <h1 class="h3">
        æ”¶ä»¶é‚®ç®±
        <a class="ml-3 text-info"
           style="font-size: 12px"
           data-toggle="collapse"
           href="#howtouse"
           role="button"
           aria-expanded="false"
           aria-controls="collapseExample">
          å¦‚ä½•ä½¿ç”¨ <i class="fe fe-chevrons-down"></i>
        </a>
      </h1>
      {% if not current_user.is_premium() %}

        <div class="alert alert-danger" role="alert">æ­¤åŠŸèƒ½ä»…åœ¨é«˜çº§è®¡åˆ’ä¸­å¯ç”¨ã€‚</div>
      {% endif %}
      <div class="alert alert-primary collapse {% if mailboxes|length == 1 %}show{% endif %}" id="howtouse" role="alert">
        <em>æ”¶ä»¶é‚®ç®±</em> åªæ˜¯å¦ä¸€ä¸ªä¸ªäººç”µå­é‚®ä»¶åœ°å€ã€‚åˆ›å»ºæ–°åˆ«åæ—¶ï¼Œæ‚¨å¯ä»¥é€‰æ‹©
        <em>æ‹¥æœ‰</em>æ­¤åˆ«åçš„é‚®ç®±ï¼Œå³ï¼š
        <br />
        - å‘é€åˆ°æ­¤åˆ«åçš„æ‰€æœ‰ç”µå­é‚®ä»¶éƒ½å°†è½¬å‘åˆ°æ­¤é‚®ç®±
        <br />
        - ä»æ­¤é‚®ç®±ï¼Œæ‚¨å¯ä»¥ä»åˆ«åå›å¤/å‘é€ç”µå­é‚®ä»¶ã€‚
        <br />
        <br />
        å½“æ‚¨æ³¨å†Œæ—¶ï¼Œå°†è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé‚®ç®±ï¼Œå…¶ä¸­åŒ…å«æ‚¨çš„ç”µå­é‚®ä»¶ <b>{{ current_user.email }}</b>
        <br />
        <br />
        é‚®ç®±ä¹Ÿä¸ä¸€å®šå¿…é¡»æ˜¯æ‚¨çš„ç”µå­é‚®ä»¶ï¼šå¦‚æœæ‚¨æƒ³ä¸ºæ‚¨çš„å¥½å‹åˆ›å»ºåˆ«åï¼Œå®ƒå¯ä»¥æ˜¯æ‚¨æœ‹å‹çš„ç”µå­é‚®ä»¶ã€‚
      </div>
      <div class="row">
        {% for mailbox in mailboxes %}

          <div class="col-12 col-lg-6">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">
                  {{ mailbox.email }}
                  {% if mailbox.verified %}

                    <span class="cursor"
                          data-toggle="tooltip"
                          data-original-title="æ”¶ä»¶é‚®ç®±å·²éªŒè¯">âœ…</span>
                  {% else %}
                    <span class="cursor"
                          data-toggle="tooltip"
                          data-original-title="æ”¶ä»¶é‚®ç®±æœªéªŒè¯">ğŸš«</span>
                  {% endif %}
                  {% if mailbox.pgp_enabled() %}

                    <span class="cursor"
                          data-toggle="tooltip"
                          data-original-title="PGP å·²å¯ç”¨">ğŸ—</span>
                  {% endif %}
                  {% if mailbox.id == current_user.default_mailbox_id %}

                    <div class="badge badge-primary float-right"
                         data-toggle="tooltip"
                         title="åˆ›å»ºæ–°çš„éšæœºåˆ«åæ—¶ï¼Œå®ƒå±äºé»˜è®¤é‚®ç®±">
                      é»˜è®¤æ”¶ä»¶é‚®ç®±
                    </div>
                  {% endif %}
                </h5>
                <h6 class="card-subtitle mb-2 text-muted">
                  åˆ›å»ºäº {{ mailbox.created_at | dt }}
                  <br />
                  <span class="font-weight-bold">{{ mailbox.nb_alias() }}</span> ä¸ªåˆ«å.
                  <br />
                </h6>
                <a href="{{ url_for('dashboard.mailbox_detail_route', mailbox_id=mailbox.id) }}">ç¼–è¾‘
                â¡</a>
              </div>
              <div class="card-footer p-0">
                <div class="row">
                  {% if mailbox.verified %}

                    <div class="col">
                      <form method="post">
                        {{ csrf_form.csrf_token }}
                        <input type="hidden" name="form-name" value="set-default">
                        <input type="hidden" class="mailbox" value="{{ mailbox.email }}">
                        <input type="hidden" name="mailbox_id" value="{{ mailbox.id }}">
                        <button class="card-link btn btn-link {% if mailbox.id == current_user.default_mailbox_id %}disabled{% endif %}">è®¾ç½®æˆé»˜è®¤æ”¶ä»¶é‚®ç®±</button>
                      </form>
                    </div>
                  {% endif %}
                  <div class="col">
                    <form method="post">
                      {{ delete_mailbox_form.csrf_token }}
                      <input type="hidden" name="form-name" value="delete">
                      <input type="hidden" class="mailbox" value="{{ mailbox.email }}">
                      <input type="hidden" name="mailbox_id" value="{{ mailbox.id }}">
                      <select hidden name="transfer_mailbox_id" value="">
                        <option value="-1">åˆ é™¤è¿™äº›åˆ«å</option>
                        {% for mailbox_opt in mailboxes %}

                          {% if mailbox_opt.verified and mailbox_opt.id != mailbox.id %}

                            <option value="{{ mailbox_opt.id }}">å°†åˆ«åè½¬ç§»è‡³ {{ mailbox_opt.email }}</option>
                          {% endif %}
                        {% endfor %}
                      </select>
                      <span class="card-link btn btn-link text-danger float-right delete-mailbox {% if mailbox.id == current_user.default_mailbox_id %}disabled{% endif %}">åˆ é™¤</span>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      <form method="post" class="mt-2">
        {{ new_mailbox_form.csrf_token }}
        <input type="hidden" name="form-name" value="create">
        <h2 class="h4">æ–°çš„ æ”¶ä»¶é‚®ç®±</h2>
        {{ new_mailbox_form.email(class="form-control", placeholder="email@example.com") }}
        {{ render_field_errors(new_mailbox_form.email) }}
        <div class="small-text mt-2">é‚®ç®±ä¸èƒ½æ˜¯ä¸€æ¬¡æ€§çš„æˆ–è€…è½¬å‘çš„ç”µå­é‚®ä»¶åœ°å€ã€‚</div>
        <button class="btn btn-primary mt-2">åˆ›å»º</button>
      </form>
    </div>
  </div>
{% endblock %}
{% block script %}

  <script>
        $(".delete-mailbox").on("click", function (e) {
            let mailbox = $(this).parent().find(".mailbox").val();

            let new_mailboxes = $(this).parent().find("select[name='transfer_mailbox_id']").find("option")
            let inputOptions = new_mailboxes.map((index, option) => { return {["value"]: option.value, ["text"]: option.text}}).toArray()

            let that = $(this);
            let message = `é‚®ç®± <b>${mailbox} æ‹¥æœ‰çš„æ‰€æœ‰åˆ«åä¹Ÿå°†è¢«åˆ é™¤ã€‚<br>` +
                "æ‚¨ä¹Ÿå¯ä»¥é€‰æ‹©å°†å®ƒä»¬è½¬ç§»åˆ°å…¶ä»–çš„æ”¶ä»¶é‚®ç®±ï¼š<br><br>";

            bootbox.prompt({
                title: '<b>åˆ é™¤ æ”¶ä»¶é‚®ç®±</b>',
                message: message,
                value: ["-1"],
                inputType: 'select',
                inputOptions: inputOptions,
                buttons: {
                    confirm: {
                        label: 'ç¡®è®¤åˆ é™¤',
                        className: 'btn-danger'
                    },
                    cancel: {
                        label: 'å–æ¶ˆ',
                        className: 'btn-outline-primary mr-auto'
                    }
                },
                callback: function (result) {
                    if (result) {
                        that.closest("form").find("select[name='transfer_mailbox_id']").val(result)
                        that.closest("form").submit();
                    }
                }
            })
        });
  </script>
{% endblock %}
